<div data-controller="chapter">
  <%= form_with(model: @post, local: true, html: { multipart: true, class: "flex flex-col" }) do |form| %>
    <% if @post.errors.any? %>
      <div id="error_explanation">
        <h2><%= pluralize(@post.errors.count, "erreur") %> erreurs ont empêché ce post d'être sauvegardé :</h2>
        <ul>
          <% @post.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="flex flex-col md:flex-row gap-8">
      <!-- Colonne de gauche -->
      <div class="w-full md:w-1/3">
        <!-- Titre -->
        <div>
          <label for="title" class="mt-8 text-l tw-form-label">Titre</label>
          <%= form.text_field :title, class: "tw-form-input" %>
        </div>

        <!-- Color Picker -->
        <div class="mt-sm">
          <label for="body" class="mt-8 text-l tw-form-label">Sélectionner une couleur</label>
          <div class="mt-xs flex items-center gap-2" data-controller="color-picker">
            <%= form.label :color, "Sélectionner une couleur", class: "tw-form-label hidden" %>
            <% color_value = @post.color || "hsl(0, 100%, 100%)" %>
            <% hue = color_value.match(/hsl\((\d+),/)[1] rescue 0 %>

            <div class="color-slider-wrapper relative w-full">
              <div class="color-bar absolute top-0 left-0 right-0 h-2 z-0"></div> <!-- Color bar with lower z-index -->
              <input type="range" min="0" max="360" value="<%= hue %>" class="relative z-10 form-range w-full" id="colorSlider" data-action="input->color-picker#updateColor" data-color-picker-target="colorSlider">
            </div>

            <%= form.hidden_field :color, id: "colorInput", value: "#{color_value}", data: { color_picker_target: "colorInput" } %>
          </div>
        </div>

        <!-- Image -->
        <div class="mt-sm">
          <label for="body" class="mt-8 text-l tw-form-label">Illustration</label>
          <ul class="nav nav-tabs hidden" id="imageTab" role="tablist">
            <li class="flex gap-2" role="presentation">
              <a class="tw-btn-secondary"> Charger une image </a>
              <a class="tw-btn-secondary"> Unsplash </a>
            </li>
          </ul>
          <div class="mt-xs">
            <%= form.file_field :photo, class: "tw-form-input" %>
            <div class="flex items-center gap-2 mt-xs">
              <%= form.check_box :image_rights, class: "tw-form-checkbox" %>
              <%= form.label :image_rights, "Je certifie avoir les droits sur cette image", class: "tw-form-label" %>
            </div>
          </div>
          <div class="flex gap-2 mt-xs hidden">
            <%= text_field_tag :query, nil, placeholder: "Recherche Unsplash", class: "form-control", data: { unsplash_target: "query" } %>
            <%= button_tag "Chercher", data: { action: "click->unsplash#search" }, type: :button, class: "tw-btn-primary" %>
          </div>
          <div data-unsplash-target="results" class="mt-3"></div>
          <%= form.hidden_field :unsplash_image_url, data: { unsplash_target: "hidden" } %>
        </div>
      </div>

      <!-- Colonne de droite -->
      <div class="w-full md:w-2/3">
        <!-- Texte -->
        <div>
          <label for="body" class="mt-8 text-l tw-form-label">Texte</label>
          <%= form.text_area :body, class: "tw-form-input" %>
        </div>

        <!-- Chapitres -->
        <div class="mt-sm">
          <div class="flex items-center justify-between">
            <span class="text-l">Chapitres</span>
            <%= button_tag "Ajouter un chapitre", type: :button, class: "tw-btn-secondary", data: { action: "click->chapter#addChapter" } %>
          </div>
          <div id="chapters" data-chapter-target="chapters">
            <%= form.fields_for :chapters do |chapter_form| %>
              <div class="chapter-fields text-sm mt-xs" data-chapter-target="chapter">
                <label class="tw-form-label">Titre du chapitre</label>
                <%= chapter_form.text_field :title, class: "tw-form-input" %>

                <label class="tw-form-label">Texte du chapitre</label>
                <%= chapter_form.text_area :body, class: "tw-form-input" %>

                <%= chapter_form.hidden_field :position %>
                <%= chapter_form.hidden_field :_destroy %> <!-- Ajout d'un champ caché pour _destroy -->

                <%= link_to "Supprimer ce chapitre", "#", class: "tw-btn-secondary", data: { action: "click->chapter#removeChapter" } %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Section du bas -->
    <div class="mt-8">
      <!-- Draft -->
      <div class="mt-sm">
        <label for="body" class="mt-8 text-l tw-form-label">Brouillon ?</label>
        <div class="mt-xs flex items-center gap-2">
          <%= form.check_box :draft, class: "tw-form-checkbox" %>
          <%= form.label :draft, "Marquer comme brouillon", class: "tw-form-label" %>
        </div>
      </div>

      <!-- CTA -->
      <div class="mt-sm">
        <% if @post.new_record? %>
          <%= form.submit "Créer le futur", class: "tw-btn-primary w-full" %>
        <% else %>
          <%= form.submit "Éditer le futur", class: "tw-btn-primary w-full" %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
